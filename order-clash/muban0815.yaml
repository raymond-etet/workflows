# ==========================================================================================
# Clash.Meta 终极优化配置 for 【OpenWrt + AdGuardHome + OpenClash】
# 1. 融合两份配置优点，采用最新、最严谨的 Clash.Meta API 语法。
# 2. DNS 结构优化：区分直连与代理 DNS，并引入 Fallback 机制，抗污染、防解析失败。
# 5. 环境适配：为 "AdGuardHome 接管 53 -> OpenClash" 架构设计，移除冲突项。
# 6. 注释详尽：对每个模块和关键参数进行完整中文注释。
#
# 架构约定：
# - AdGuard Home 监听 53 端口作为主 DNS。
# - AdGuard Home 的上游 DNS (Upstream) 指向 Clash 的 DNS 监听端口 (7874)。
# - OpenClash 使用 Redir 模式进行透明代理，不使用 TUN 模式。
# - 规则集采用 GeoIP 和 GeoSite，不使用外部 rule-set 文件。
# ==========================================================================================

# ----------------- 基础端口与网络设置 -----------------
port: 7890 # HTTP 代理端口
socks-port: 7891 # SOCKS5 代理端口
mixed-port: 7893 # HTTP 和 SOCKS5 混合端口
redir-port: 7892 # 透明代理 (Redirect) TCP 端口
tproxy-port: 7895 # 透明代理 (TProxy) UDP 端口 (即使主要用redir，也建议保留定义)
allow-lan: true # 允许局域网连接
bind-address: "*" # 监听所有网络接口的连接
mode: rule # 规则模式，根据 `rules` 列表进行分流
log-level: warning # 日志级别，'warning' 能显著减少不必要的日志输出，降低系统负载
external-controller: 0.0.0.0:9090 # 外部 UI 控制器地址，允许局域网内所有设备访问
secret: "" # 外部控制器密钥，留空表示不鉴权

# ----------------- 客户端伪装 (UA/TLS 指纹) -----------------
global-client-fingerprint: chrome
global-ua: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36 QuarkPC/4.3.2.472"

# ----------------- DNS 核心配置 (关键优化区) -----------------
dns:
  listen: 0.0.0.0:7874 # DNS 监听地址，AdGuardHome 应将此设为上游
  ipv6: false # 禁用 IPv6 解析。国内环境 IPv6 支持不佳，关闭可避免解析错误和网络延迟
  use-hosts: true # 使用系统 hosts 文件
  respect-rules: true # DNS 解析结果将遵循分流规则
  fake-ip-range: 198.18.0.1/16 # Fake-IP 使用的 IP 段，采用私有地址段，避免冲突
  # [上游 DNS 服务器]
  # 用于解析【直连域名】(如国内网站) 的 DNS，追求速度与无污染
  # 注意：default-nameserver 必须使用纯IP地址，不能使用DoH/DoT格式
  fake-ip-filter:
    # 局域网 & IoT
    - geosite:cn # 国内域名全部返回真实 IP
    - geosite:private
    - "+.lan"
    - "+.local"
    - "+.localdomain"

    # Windows / macOS 连通性检测
    - "+.msftconnecttest.com"
    - "+.msftncsi.com"
    - "+.apple.com"
    - "+.push-apple.com.akadns.net"

    # STUN / 时间同步 / GitHub
    - time.*.com
    - "+.stun.com"
    - "+.stun.net"
    - "+.github.com"
    - "+.githubusercontent.com"
    - "+.githubassets.com"

      # ===== GitHub 系列 =====
    - +.github.com
    - +.githubusercontent.com
    - +.githubassets.com
    - +.githubapp.com
    - +.ghcr.io

      # 增加以下规则解决 DNS 解析问题
    - "+.router.asus.com"
    - "+.local.adguard.org"
    - "+.adguardhome.local"
    - "localhost.ptlogin2.qq.com"
    - "+.srv.nintendo.net"
    - "+.stun.playstation.net"

  # ------------- 普通公共 DNS 列表 -------------
  default-nameserver: # 国内兜底，仅用 IP
    - 139.9.23.90 # 国内最快 114DNS
    - 119.29.29.29 # DNSPod，备用

  nameserver: # 可能被代理用的 DNS (海外)
    - https://cloudflare-dns.com/dns-query
    - https://dns.google/dns-query

  proxy-server-nameserver: # 仅解析节点域名使用，必须是纯 IP
    - 1.1.1.1
    - 8.8.8.8

  # ------------- DNS 域名级策略（2025 之后推荐全写这里） -------------
  nameserver-policy:
    # 规则一：大陆（含香港）所有等业务域名 → 用国内最快的两组
    "geosite:cn,apple-cn,microsoft@cn,category-games@cn,private":
      - 139.9.23.90 # 国内最快 114DNS
      - 119.29.29.29 # DNSPod，备用

    # 规则二：iCloud 及其子服务 → 交回系统 DNS，兼容苹果设备
    "geosite:icloud": dhcp

    # 规则三（兜底）：所有其他域名 → 走国外无污染 DoH
    "geosite:geolocation-!cn": "nameserver"

# ----------------- 流量嗅探 (Sniffer) -----------------
sniffer:
  enable: true
  parse-pure-ip: true
  override-destination: true
  sniffing: [TLS, HTTP, QUIC]
  force-domain:
    # 流媒体：分区最严
    - "+.netflix.com"
    - "+.disneyplus.com"
    - "+.hulu.com"
    - "+.hbo.com"
    - "+.amazonprime.com"

    # 游戏：不同区域匹配不同入口
    - "+.steamcontent.com" # Steam 下载 CDN
    - "+.epicgames.com"

    # 银行的国际站
    - "+.paypal.com"

# --- 代理节点 (Proxies) ---

# ----------------- 路由规则 (Rules) -----------------
# 规则从上到下依次匹配，一旦匹配成功，则不再继续匹配
# AdGuardHome 已处理广告，此处规则可作为补充
rules:
  # -- 直连规则 --
  - GEOIP,PRIVATE,DIRECT # [最佳实践] 私有/保留地址直连，最高优先级
  - GEOSITE,private,DIRECT # GeoSite 私有地址规则
  - DOMAIN-SUFFIX,pc528.net,DIRECT
  - DOMAIN-SUFFIX,pc521.net,DIRECT
  - GEOIP,CN,DIRECT # 中国大陆 IP 直连
  - GEOSITE,cn,DIRECT # 中国大陆域名直连
  - GEOSITE,apple-cn,DIRECT # 苹果中国服务直连
  - GEOSITE,microsoft@cn,DIRECT # 微软中国服务直连
  - GEOSITE,category-games@cn,DIRECT # 国内游戏直连

  # -- 兜底规则 --
  - MATCH,🚀 节点选择 # 所有未匹配的流量均走代理

# ----------------- 性能与连接调优 -----------------
tcp-concurrent: true # [性能] 启用 TCP 并发连接，加快网站打开速度
udp-idle-timeout: 60 # UDP 会话空闲超时时间 (秒)
keep-alive-idle: 600 # TCP Keep-Alive 空闲时间 (秒)
keep-alive-interval: 15 # TCP Keep-Alive 探测间隔 (秒)
udp-strategy: resolve-after-socks5 # [新特性] UDP 流量在 SOCKS5 握手完成后再解析目标地址，减少不必要的 DNS 解析
find-process-mode: strict # 严格模式查找进程，更准确
interface-name: "" # 出口网卡名称，留空则自动选择
routing-mark: 0 # 设置 SO_MARK，用于配合 Linux 策略路由，一般留空或为 0

# ----------------- 持久化配置 -----------------
profile:
  store-selected: true # 记住上次在 UI 中选择的策略组节点
  store-fake-ip: true # 缓存 Fake-IP 与真实 IP 的映射关系，重启后恢复，加快连接速度

# ----------------- 实验性功能 -----------------
experimental:
  unified-delay: true # 统一计算所有类型节点的延迟，结果更具可比性
  ignore-resolve-fail: true # 忽略 DNS 解析失败，避免单个解析失败阻塞所有连接
  cache-file: /tmp/clash.meta.db # 缓存文件路径
  cache-size: 100000 # 最大缓存条目数
  cache-ttl: 3600 # 缓存过期时间 (秒)，1 小时

# ----------------- Geo-Database (地理数据库) -----------------
geodata-mode: true # 启用 GeoIP 和 GeoSite
geodata-loader: standard # 推荐 8GB 内存以上设备，性能更好
geo-auto-update: true # 自动更新 Geo 数据库文件
geo-update-interval: 24 # 每 24 小时更新一次
geo-auto-fallback: true # 更新失败后自动切换到其他镜像源
